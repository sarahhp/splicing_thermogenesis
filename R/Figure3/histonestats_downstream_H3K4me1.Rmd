---
title: "histone_stats_downstream_H3K4me1"
output: html_document
---

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(ggrepel)
```


```{r}
WINDOWS= "C:/Users/sarahhp/OneDrive - Universitetet i Oslo/Projects/rnaseq/beige_rnaseq_jul22/31_leafcutter/histone_profile/new_TSS"

histone = "H3K4me1"
window = "-500%3A4000"
tss_sets = c("beige","white","not_sig")

enrich_tables = list()
for (set in tss_sets){
  file = file.path(WINDOWS, histone, paste0("window", window), paste0(set,".",window, "_white_beige.tab"))
  annot = read.delim(file, quote="'")
  colnames(annot)[grep("chr", colnames(annot))] = "chr"
  annot$tss_set = set
  enrich_tables[[set]] = annot
}
str(enrich_tables)

annot <- do.call(rbind, enrich_tables)
table(annot$tss_set)
head(annot); nrow(annot)
```

```{r}
long = pivot_longer(annot, grep("Adi.",colnames(annot)), names_to = "context", values_to = "mean_enrichment")
long$context = factor(long$context, levels=c("White_Adi.","Beige_Adi."))
long$tss_set = factor(long$tss_set, levels=c("white","beige","not_sig"))
```


```{r}
ggplot(long, 
       aes(x=tss_set, y=mean_enrichment, color=context)) +geom_violin()+ 
    geom_boxplot(fill=NA, position=position_dodge(0.9)) +scale_color_manual(values= c("dodgerblue","orange"))+ ggtitle(histone)
```
H3K4me3 signal is always higher in the beige sample.  To normalise, we could compare the signal to the average of the background and the two sets for each sample.  Or we could also calculate a zscore for each ChIP.  that makes a lot of sense.  Average will be weighted towards the background, but not too heavily.  

```{r}
relative = long %>% group_by(context) %>% mutate(zscore = scale(mean_enrichment), group=paste0(context, tss_set))
relative$group = factor(relative$group, levels=paste0(rep(levels(relative$context),each=3), levels(relative$tss_set)))

ggplot(relative, 
       aes(fill=tss_set, y=zscore, x=context, group=group)) + geom_violin() +
    geom_boxplot(fill=NA, width=0.5, position= position_dodge(0.9), outlier.shape = NA) + scale_fill_manual(values= c("dodgerblue","orange","grey")) +
    theme_classic(base_size=18) + ylab("Relative Enrichment") + ggtitle(paste(histone,window))
ggsave(file.path(WINDOWS, histone, paste0(histone, "_downstream_violin_plot.pdf")))

ggplot(relative, 
       aes(x=tss_set, y=zscore, fill=context, group=group)) + geom_violin() +
    geom_boxplot(fill=NA, width=0.5, position= position_dodge(0.9))+scale_fill_manual(values= c("dodgerblue","orange")) +
  theme_classic(base_size=18) + ylab("Relative Enrichment")+ ggtitle(paste(histone, window))

```


```{r}
summary(aov(zscore ~tss_set+context, data=relative))
#print(kruskal.test(zscore ~ tss_set * context, data=relative)) #cannot run a kruskal wallis with interactions.

compare_means(zscore ~ tss_set, data=relative, method="wilcox.test", group.by="context")
```

With the subsampled background analysis of last time using a zscore meant the background was different between the two chip conditons.  With removing DEG and using a larger background we get a more consistent average H3relative signal between the two conditions. 

```{r}
summary(aov(zscore ~tss_set*context, data=relative))
compare_means(zscore ~ context, data=relative, method="t.test", group.by="tss_set") # <- not significant by ANOVA, so not reporting
```



